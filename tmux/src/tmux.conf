set-environment -g PATH "/home/vaab/.local/bin:/opt/merge/bin:/bin:/usr/bin"
#set -g @override_copy_command '/tmp/debug'
set-environment -g TMUX_PLUGIN_MANAGER_PATH '~/.local/share/tmux/plugins'

##
## Server options (set -s)
##


## tmux-256color supports italic, whereas screen-256color doesn't
#set -g default-terminal "tmux-256color"
set -g default-terminal "xterm-256color"
set -as terminal-overrides ",xterm*:Tc"
set -as terminal-overrides ",xterm-256color:RGB"
set -ga terminal-features "*:hyperlinks"

## True color support (24-bit) has to be enforced when tmux is started
## from systemd, because systemd can't pass the TERM/COLORTERM variable
set-environment -g COLORTERM truecolor
set-environment -g DISPLAY ":0"

## Copy-mode and passthrough clipboard
set -g set-clipboard on

set -sg escape-time 10

##
## Plugins
##

set -g @resurrect-processes 'vi vim nvim emacs man less more tail top htop irssi weechat mutt watch'
set -g @resurrect-dir '~/.local/state/tmux/resurrect'


set -g @plugin 'laktak/extrakto'
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'
#set -g @plugin 'akohlbecker/aw-watcher-tmux'

## XXXvlab: these settings need to be before the loading of the plugin
set -g @continuum-save-interval '6'  # in minutes
set -g @continuum-restore 'on'


##
## Key bindings
##
bind -T copy-mode-vi C-d send -X cancel \; send-keys C-d
bind -T copy-mode C-d send -X cancel \; send-keys C-d
bind -T copy-mode C-w send -X copy-selection-no-clear
bind -T copy-mode M-w send -X copy-pipe-no-clear
# bind -T copy-mode MouseDown1Pane send -X cancel \; send -X clear-selection
bind -T copy-mode MouseDown1Pane display "click" \; send -X cursor-move \; send -X cancel \; send -X begin-selection
bind -T copy-mode-vi MouseDown1Pane display "click" \; send -X cursor-move \; send -X cancel \; send -X begin-selection

# Use Alt-arrow keys without prefix key to switch panes
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

#bind -n M-h select-pane -L
#bind -n M-l select-pane -R
#bind -n M-k select-pane -U
#bind -n M-j select-pane -D


## mode indicator

set -g @mode_indicator_prefix_prompt " ^B "
set -g @mode_indicator_copy_prompt 'COPY'
set -g @mode_indicator_sync_prompt 'SYNC'
set -g @mode_indicator_empty_prompt ' -- '
set -g @mode_indicator_prefix_mode_style 'bg=blue,fg=colour255,bold'
set -g @mode_indicator_copy_mode_style 'bg=yellow,fg=colour0,bold'
set -g @mode_indicator_sync_mode_style 'bg=red,fg=black'
set -g @mode_indicator_empty_mode_style 'bg=colour234,fg=colour246,nobold'

set -g @plugin 'MunifTanjim/tmux-mode-indicator'


unbind -n S-Left
unbind -n S-Right

## C-S-e Can't work properly in a terminal, it'll be the same than C-e.
## Using the terminal app to catch these and translate the the C-b ... 
bind \" split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

bind -T copy-mode C-g if -F '#{selection_present}' 'send -X clear-selection' 'send -X cancel'
bind -T copy-mode Escape if -F '#{selection_present}' 'send -X clear-selection' 'send -X cancel'


bind-key C-p swap-window -t -1\; select-window -t -1
bind-key C-n swap-window -t +1\; select-window -t +1
unbind -n C-S-Left
unbind -n C-S-Right


## XXXvlab: 2025-08-06 not using these, and they override the `s` to switch
## sessions, that I clearly overlooked before and want to give a try:

## Join windows: <prefix> s, <prefix> j
#bind-key j command-prompt -p "join pane from:"  "join-pane -s '%%'"
#bind-key s command-prompt -p "send pane to:"  "join-pane -t '%%'"

#set -g @plugin 'tmux-plugins/tmux-yank'
#set -g @yank_selection 'primary'
#set -g @yank_selection 'clipboard'

bind * set-window-option synchronize-panes
#bind e set-window-option -g mode-keys vi
## Define a custom command to toggle between modes

## Switching between modes
bind -T copy-mode T send-keys -X clear-selection \; set-window-option -g mode-keys vi \; display-message "vi mode"
bind -T copy-mode-vi T send-keys -X clear-selection \; set-window-option -g mode-keys emacs \; display-message "emacs mode"


bind r source ~/.config/tmux/tmux.conf



set -g history-limit 150000
set -g xterm-keys on

## Start counting at 1 for tab and pane numbers (0 is far on a keyboard)
set -g base-index 1
set -g pane-base-index 1

setw -g aggressive-resize on

## Mouse support (not really sure this is good)
#setw -g mode-mouse on
#set -g mode-mouse on
#set -g mouse-select-window on
#set -g mouse-select-pane on
set -g mouse on

set -g display-panes-time 3000  # (which is 2sec)


##
## VISUALS inspired from wemux
##   https://gist.github.com/zolrath/2305333

set -g status-left-length 32
set -g status-right-length 150

set -g status-style fg=white,bg=colour234
set -g window-status-activity-style bold
set -g pane-border-style fg=colour245
set -g pane-active-border-style fg=colour39
set -g message-style fg=colour16,bg=colour221,bold

# set -g status-left '#[fg=colour235,bg=colour252,bold] ❐ #S #[fg=colour252,bg=colour238,nobold]⮀#[fg=colour245,bg=colour238,bold] #(whoami) #[fg=colour238,bg=colour234,nobold]⮀'
set -g status-left '#[fg=colour235,bg=colour252,bold] ❐ #S #[fg=colour252,bg=colour234,nobold]'

set -g window-status-format " #[fg=colour242,bg=colour234] #I #[fg=colour238,bg=colour234]#[fg=colour248,bg=colour234] #W  "
set -g window-status-current-format "#[fg=colour234,bg=colour39]#[fg=colour236,bg=colour39,noreverse,bold] #I  #W #[fg=colour39,bg=colour234,nobold]"
#set -g status-right "#(wemux status_users)"
set -g status-right "#{tmux_mode_indicator} #[fg=colour252,bg=colour234,nobold]#[fg=colour235,bg=colour252,bold] #(hostname) "

set -g renumber-windows on

bind-key P command-prompt -p 'save history to filename:' -I '/tmp/tmux.history' 'capture-pane -S -32768 ; save-buffer %1 ; delete-buffer'
set -g @resurrect-capture-pane-contents 'on'

set -s extended-keys on
set -as terminal-features 'xterm*:extkeys'

set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

set -g word-separators "!\"#$%&'()*+,:;<=>?@[\\]^`{|}~"
# set -g mode-keys "emacs"  ## must set if EDITOR is not 'emacs' or 'vim'
# set -g status-keys "emacs"  ## must set if EDITOR is not 'emacs' or 'vim'

#bind -T copy-mode-vi MouseDown1Pane select-pane \;\
#    send-keys -X copy-pipe "pbcopy" \;\
#    send-keys -X clear-selection

display "tmux conf reloaded"
## Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
#run '~/.local/share/tmux/plugins/tpm/tpm'
if-shell '[ -d ~/.local/share/tmux/plugins/tpm ]' "run-shell ~/.local/share/tmux/plugins/tpm/tpm"

## Do not copy selection and cancel copy mode on drag end event
## Prefer iTerm style selection: select, then mouse click to copy to buffer
unbind-key -T copy-mode-vi MouseDragEnd1Pane
unbind-key -T copy-mode MouseDragEnd1Pane

## since MouseDragEnd1Pane neither exit copy-mode nor clear selection now,
## let single click do selection clearing for us.
## XXXvlab: nope, 'q' or 'Ctrl-G' is enough
bind-key -T copy-mode-vi MouseDown1Pane select-pane \; send-keys -X clear-selection
bind-key -T copy-mode MouseDown1Pane select-pane \; send-keys -X clear-selection

## Do not copy selection and cancel copy mode on double click
bind -n DoubleClick1Pane copy-mode \; send -X select-word

## Do not copy selection and cancel copy mode on triple click
bind -n TripleClick1Pane copy-mode \; send -X select-line

# Without this, M-Up/Down in copy-mode will pageup and stay in current pane.
bind -T copy-mode M-Up select-pane -U
bind -T copy-mode M-Down select-pane -D

## Don't put old window name by default in prompt
bind-key , command-prompt "rename-window '%%'"
set -g repeat-time 0

## this line changes the default binding of MouseDrag1Pane, the only difference
## is that we use `copy-mode -eM` instead of `copy-mode -M`, so that WheelDownPane
## can trigger copy-mode to exit when copy-mode is entered by MouseDrag1Pane
#bind -n MouseDrag1Pane if -Ft= '#{mouse_any_flag}' 'if -Ft= \"#{pane_in_mode}\" \"copy-mode -eM\" \"send-keys -M\"' 'copy-mode -eM'


# Wheel-up: start copy-mode only if we are not already in a mode
bind -Troot WheelUpPane \
     if -F '#{||:#{pane_in_mode},#{mouse_any_flag}}' \
              'send-keys -M' \
              'copy-mode'


## Tmux sessionizer

# install with `cargo install tmux-sessionizer
run-shell 'case ":$PATH:" in *:"$HOME/.cargo/bin":*) ;; \
          *) tmux setenv -g PATH "$HOME/.cargo/bin${PATH:+:$PATH}";; esac'
bind C-u display-popup -E "tms"


run-shell 'tmux setenv -g TMUX_SCRIPT_DIR ~/.config/tmux'

#bind s display-popup -E '$TMUX_SCRIPT_DIR/session-picker-fzf switch'
#bind s display-popup -E 'tms switch'

bind s set-environment -F CURRENT_SESSION "#{client_session}" \; \
    display-popup -E 'rs-tmux-fzf switch-from "$CURRENT_SESSION"'


#bind m display-popup -E '$TMUX_SCRIPT_DIR/session-picker-fzf move-window'
bind m set-environment -F CURRENT_SESSION "#{client_session}" \; \
       set-environment -F WINDOW_ID "#{window_id}" \; \
       display-popup -E 'rs-tmux-fzf move-window "$CURRENT_SESSION" "$WINDOW_ID"'

bind . command-prompt -I "#S" { rename-session "%%" }

set -g detach-on-destroy off


## Wheel-down: remove automatically copy-mode only if no selection
## active
bind -Tcopy-mode WheelDownPane \
     if -F '#{selection_present}' \
               'send -X -N 3 scroll-down' \
              'if-shell -F "#{==:#{scroll_position},0}" \
                        "send -X cancel;" \
                        "send -X -N 3 scroll-down"'
